---
layout: _page
title: 模型动画开发技术(四元数插值)
tags Tools:
---

### 模型动画开发技术文档
*****************

## 1.背景
在配准时，我们一般可以通过模型或者点云数据得到一个配准矩阵T。通常情况下，
我们首先假设原始的模型为M，那么模型在变换之后的位置就是$M^{'}$。所以我们可以得到
公式
$$
M^{'}=T*M
$$
但是，这在视觉上会有一个模型突然变换位置的情况出现。不够美观。因此，我想实现一种类似与矩阵插值的方式，通过定时器实现一种平滑的过度。

## 2.四元数

对于四元数的知识，网上有很多教程，在另一篇文章中我也写自己的一点理解。[四元数旋转插值](./工作记录本.md)
这里主要对这块做进一步的说明
4. 对于过度动画，难点就是在动画执行过程中再次插值，导致出现奇怪的问题。例如:

```C++
void ShortcutToolSpace::QuatTrans::setTransMat(const std::shared_ptr<core::MatrixTransform>& rootNode, 
const core::Matrix44f& transMat,float duration)
{

    impl_->rootNode_ = rootNode;
    impl_->duration_ = duration;

    if (impl_->nodeReTMat_.Determinant() == 1.0f)
    {
        impl_->nodeReTMat_ = transMat * impl_->rootNode_->getWorldMatrix();
    }
    else
    {
        impl_->nodeReTMat_ = transMat * impl_->nodeReTMat_;
    }

    impl_->nodeOriMat_ = impl_->rootNode_->getWorldMatrix();
    Matrix44f tM = impl_->nodeReTMat_ * Inverse(impl_->nodeOriMat_);

    impl_->qR_.FromMatrix(tM);
    impl_->moveVec_= tM.GetColumn3(3);

    impl_->timer_.start();
}
```
对于传入一个变换矩阵T而言，如前面所述，它的变换应该如：
$$
M^{'}=T*M
$$
但是当动画执行到一半时，又执行新的动作该怎么办？比较常见的情况就是撤销恢复时，当然可以允许连续点击多次撤销按钮。而这多次连续点击往往小于一个完整动画执行完成的间隔。这是按照先前的方式。动画就会出现异常。

对此，我们先做一定的假设和限制。
1. 代码中。``impl_->rootNode_->getWorldMatrix()``返回的是模型当前的变换矩阵TC。也就是模型原始位置经过一定的变换后，现在的位置！
2. 我们将一个变换T分解成两个变换，即$TM=T2*T1$.

因此，我们假设我们先做第一次变换。此时所有的矩阵均为单位矩阵，因此，
$$
TM=T2*T1*M\\
TO=TC=M\\
TR=T2*T1
$$
这里，我们假设动画在执行到一半时，执行了新的变换。于是，我们有：
$$
TC=T1*M\\
TM=T4*T3*T2*T1;\\
TR=T4*T3*T2*T1*M;
$$
从公式里可以看到，$TR!=TM*TC$.
其实，真正的TM应该为
$$
TM=T4*T3*T2;
$$
因此，在TR第一次初始化的时候，令其为：
$$
if(firstInit)\\
TR=t=TM*M=T2*T1*M\\
else\\
TR=TM*TR=T4*T3*T2*T1*M
$$
于是更具当前的$TC=T1*M$
我们可以得到变换矩阵
$$
TM=TR*Inverse(TC)=T4*T3*T2*T1*M*(T1*M)^{-1}=T4*T3*T2
$$
这样，我们就得到了此次变换的其实矩阵$TO=T1*M$,变换矩阵$TM=T4*T3*T2$,这样就可以继续执行四元数插值变化了！
