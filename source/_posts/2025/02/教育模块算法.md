---
layout: _page
title: 教育模块算法
tags: 算法
categories: 
    - 算法
    - 几何
---

## <center>教育模块评分算法说明

### 1. 主要包含的算法内容:

--------
1. 邻牙距离评分
2. 邻牙面积评分
3. 咬合距离评分
4. 咬合面积评分
5. 边缘脊评分
6. 牙弓曲线评分
-----

其中，1-4可以使用同一个算法来实现，5, 6分别计算，此外，还需要考虑前牙与后牙，三连桥等情况，以下以此说明。

### 2. 距离面积算法

主要的实现思路：

1. 已知条件：
    1. 老师，学生的模型mesh数据
    2. 老师会在其相应的位置标记属性值，可以直接通过模型mesh数据结构拿到属性值
    3. 老师，学生模型的三个主要方向：插入方向(insert)，近中方向(near)，颊侧方向(buccal)
    4. 邻牙模型mesh数据
    5. 对颌模型mesh数据
    6. 老师，学生模型的颈缘线数据
    此处，命名
        1. 老师的模型数据为 ***tMesh***
        2. 学生的模型数据为 ***sMesh***
        3. 邻牙的模型数据为 ***neigbMesh***
        4. 对颌的模型数据为 ***occMesh***
        5. 老师的方向数据为 ***tDI,tDN,tDB***
        5. 学生的方向数据为 ***sDI,sDN,sDB***

2. 先考虑普通的后牙单冠情况
    1. 由于老师，学生的模型可能存在空间位置，大小的差异，因此，我们采用映射的方式计算得分

    2. 首先通过三个方向 ***tDI,tDN,tDB***,我们对老师模型 ***tMesh***分别进行投影。由此可以计算出模型带方向的包围盒。对于邻牙，我们选取 ***tDN*** ，对于咬合，我们选取 ***tDI*** 为法线的包围盒中的的四边形作为一个平面 ***tPlant***。 此外，在计算包围盒时，我们需要计算模型的中心到对应包围盒平面左上角的距离，此外，我们还需要计算对应属性点的形成的投影平面。通过这三份数据，我们就可以确定老师属性点对应的拟合平面 ***tMarkPlant***。

    3. 构建该拟合平面的目的，其实是为了记录老师的属性点。我们以老师的属性点为起点，对于邻牙，我们选取 ***tDN*** ，对于咬合，我们选取 ***tDI*** 为参考方向 ***refDir*** 打出一道射线。将必然会与前面的拟合平面 ***tMarkPlant*** 有交点。

    4. 为了记录该交点，我们需要对平面 ***tMarkPlant*** 做一些分块处理。这里简单的将其分成 ``50 x 50``大小，对于分割操作，我们将设点达到的点与 ***tMarkPlant*** 的左上角顶点相减，得到一条向量，再分别与平面的长宽方向做投影，就可以简单的得到该点在长x宽方向的长度，我们分别除以各方向的长度，再乘50，取余后，就可以得到该点在该平面的坐标。通过这种方式，我们就可以记下老师各属性点的位置。并映射到学生的平面上。

    5. 得到属性点后，我们最后计算距离值和面积值。我们先朝前述的反方向 ***-refDir*** 打一条射线。并记录此时的距离值 ***d1***, 以此处为新射线的交点，方向为 ***-refDir*** 继续打射线，若先打到 ***neigbMesh*** 和 ***occMesh*** 等参考模型 ***refMesh*** 的距离值小于一个阈值，这表明，我们的设计体模型穿透了 ***refMesh***,我们的模型与 ***refMesh*** 有碰撞。我们记录此时的距离值 ***d2*** ，则该点到 ***refMesh*** 的距离值为 ***-d2***，若前述射线不满足该条件，则再次朝 ***refDir***方向打射线，其与 ***refMesh*** 的距离值便是到交点的距离 ***d3***。 
    
    6. 在计算碰撞时，可能会出现设计体内部也存在 ***refMesh*** 的情况，为了排除该情况，我们需要在第一步之前对 ***refMesh***做预处理。对于对颌，该情况不会出现，对于邻牙，我们需要删除调设计体内部的面片结构。方法是，以设计体颈缘线为拟合平面，朝插入方向打一道射线，得到一个交点。以该交点为起点，向四周扩散，边界条件是其顶点到颈缘线的距离小于一个极小值。通过此方法，可以成功删除***refMesh***  中设计体颈缘线上部的面片。

    7. 最后，我们成功得到了老师，学生的距离值，为了将其转换成分数，我们以老师的为依据计算得分。此处使用了两种不同的计算方式。分别是平均值法以及极大值法。对于邻牙的评分，注意，这里的距离值还需要乘以前述交点处的法向量，我们采用极大值法，对于咬合的评分，我们采用平均值法。下面分别概述：
        1. 极大值法
            对于所有点，我们首先得到老师与学生的距离值差，并且排查差值特别大的点，已排除特殊点。最后将所有点的差值排序，得到前10个最大的差值，求平均值。
        2. 平均值法
            对于所有差值，我们按照位置，以（25，25）为中心，生成一个二维的高斯概率分布函数，以此设计生成权重值，表明中心区的权重值更高，边界处权重较低。最后，通过加权差值的评分和再求平均得到平均值。
    8. 对于面积分数，我们可以计算前述中的碰撞块的个数差异值得到。


3. 考虑前牙的距离面积

    1. 前牙相比于后牙，对于邻牙距离的计算是相通的，但是对于咬合面，存在一定的差异。这是由于咬合面的拟合法向量与插入方向已经存在较大的差异，导致计算的得到的距离值不精准。因此，我们需要做更一步的处理。

    2. 这里的距离值差异主要是由两部分引起。
        1. 对颌的位置。按照后牙的计算方法，前牙的对颌往往不在其咬合面上，导致无法计算分数。因此，对于距离值，我们以2）中的拟合平面为依据来计算距离值，而不在以对颌为依据。
        2. 对于距离值，若按照插入方向计算，其计算结果往往偏大，因此，此处也同2）已有需要在计算交点值时记录交点处面片的法向量。后面计算时需要将距离值与法向量点成，将其折算成面片法向量方向的投影。

### 3. 边缘脊算法

0. 边缘脊算法的实现思路
    1. 以模型的中点，以近中方向为为初始平面方向，记为 ***dxy***,以插入方向为起点方向，记为 ***dxyz*** ,分别做射线，即可得到模型在该方向的切平面。旋转初始平面方向，即可得到各个切平面。

    2. 以某个切平面来看，依照截面可以看到，边缘脊上的某个点其实就是曲线的拐点。

    3. 连接起始点和终点，以此为参考斜率，在截面曲线上找到最相似的点，该点即为边缘脊点。

1. 后牙单冠的边缘脊算法
    1. 对于后牙单冠，按照前述的实现思路,即可计算得到老师，学生冠的边缘脊。

    2. 对于老师模型，我们可以取到属性点，将包含在属性点外的边缘脊移除。得到标记区的边缘脊，此外，还需要计算边缘脊标记区的范围。此处以 ***tDD***为依据，可以得到标记区的角度上下限，以 ***-tDN*** 为依据，可以得到标记区的范围。

    3. 依据2中的范围，可以以同样的方式计算出学生的相应边缘脊

    4. 根据老师，学生的边缘脊，使用DTW算法，计算得到得分

2. 前牙单冠的边缘脊算法
    1. 相比于后牙，前牙的边缘脊差异在于z方向不同。因此，此处考虑重建坐标系，然后便可以以后牙的方式计算边缘脊
    2. 这里以模型的中点为原点，朝模型的舌侧方向打一道射线，得到原点，以该点为中心，向四周扩散，边界条件为新的面片法向量与模型的舌侧方向同向。累计新的面片的法向量和，最后归一化，得到模型舌侧方向法向量。并以此为z轴，y轴为z轴与插入方向的叉乘,x轴为y轴与z轴的叉乘。

3. 三连桥的边缘脊计算
    1. 三连桥不能简单的之前使用0）中的计算思路，简单的办法就是把三连桥模型拆开单独计算。由于三连桥模型中间模型往往为桥体，具体特殊的模型属性值。再根据颈缘线数据，就可以将三连桥拆出来后，分别计算边缘脊得分。
    

### 牙弓曲线算法

1. 此处牙弓曲线算法按照其包围盒的相似度来计算。同时也要考虑三连桥的问题，因此，若是三连桥，则需要采用前文的方式将模型拆开

2. 包围盒计算如计算距离咬合那样，以个方向的投影来计算包围盒

3. 对于包围盒的相似度，这里采用体积相似度，以及包围盒中点的位置相似度两者按比例协调分配。最后计算得分。

